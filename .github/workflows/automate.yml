name: Run Scraper

on:
  workflow_dispatch:

# ðŸ”¥ THIS IS THE KEY FIX
# This ensures only one run of "scraper-group" happens at a time.
# If a new one starts, it will cancel the old one (or you can make it queue).
concurrency:
  group: scraper-group
  cancel-in-progress: false 
  # Set 'false' to QUEUE the new run (wait for the first to finish).
  # Set 'true' to CANCEL the current run and start the new one immediately.

jobs:
  scrape-job:
    name: Run Scraper Script
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install playwright
          playwright install chromium

      - name: Run Scraper Script
        env:
          CI: true
        run: python automate_actions.py

      # The Robust Push Strategy
      - name: Commit and Push Progress
        if: always()
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # 1. Stash changes
          git add processed-chunk-1.json
          git stash
          
          # 2. Retry Logic for Pulling
          # If the pull fails (rare race condition), wait 10s and try again
          n=0
          until [ "$n" -ge 5 ]
          do
             git pull --rebase origin main && break
             n=$((n+1)) 
             echo "Pull failed, retrying in 10s..."
             sleep 10
          done
          
          # 3. Pop Stash
          git stash pop || echo "No stash to pop or conflict auto-resolved"
          
          # 4. Commit and Push
          git add processed-chunk-1.json
          git commit -m "Update progress: $(date)" || echo "No changes to commit"
          git push origin main

      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scraper-logs
          path: logs/
          retention-days: 3
